# !/bin/bash
#
# Use this script on an OSX or Linux machine to sync plugings on WSUWP with
# your local environment. This requires access to wsuwp-prod-01 and matching
# SSH configuration.
#

if [[ -f 'pull_mu_plugins' ]]; then
  LOCAL_PLUGINS='../www/wp-content/mu-plugins'
elif [[ -f 'Vagrantfile' ]]; then
  LOCAL_PLUGINS='www/wp-content/mu-plugins'
else
  echo "Error: Run from the project root or bin directory"
  exit
fi

cd $LOCAL_PLUGINS

if [[ ! -f 'mu-exclude.txt' ]]; then
  touch mu-exclude.txt
fi

if [[ -f 'mu-exclude-auto.txt' ]]; then
  rm mu-exclude-auto.txt
fi

touch mu-exclude-auto.txt

for GIT_DIR in $(find . -maxdepth 2 -name '.git'); do
    echo $(basename $(dirname $GIT_DIR)) >> mu-exclude-auto.txt
done

rsync -avz --delete --exclude-from 'mu-exclude-auto.txt' --exclude-from 'mu-exclude.txt' --exclude './*.php' --exclude 'mu-exclude-auto.txt' --exclude 'mu-exclude.txt' wsuwp-prod-01:/var/www/wp-content/mu-plugins/ ./
